<script>
        // --- CONFIGURATION: LEVELS ---
        const LEVELS = [
            {
                image: "747.jpg", 
                answers: ["boeing 747", "747", "b747", "jumbo jet"],
                name: "Boeing 747"
            },
            {
                // LEVEL 2
                image: "a380.jpg", 
                answers: ["airbus a380", "a380", "super jumbo"],
                name: "Airbus A380"
            },
            {
                // LEVEL 3
                image: "concorde.jpg", 
                answers: ["concorde", "bac concorde"],
                name: "Concorde"
            }
        ];

        const GAME_DURATION = 60; 
        const REVEAL_SPEED = 200; 
        
        // --- STATE ---
        let currentLevelIndex = 0;
        let timeLeft = GAME_DURATION;
        let timerInterval;
        let revealInterval;
        let isGameRunning = true;
        let score = 0;
        
        // --- DOM ---
        const gridContainer = document.getElementById('cover-grid');
        const timerDisplay = document.getElementById('timer-container');
        const inputField = document.getElementById('guess-input');
        const enterBtn = document.getElementById('enter-btn');
        const messageDisplay = document.getElementById('message');
        const mysteryImage = document.getElementById('mystery-image');
        const headerTitle = document.querySelector('header h2'); // To show "Level 1/3"

        function initGame() {
            console.log("Game Starting...");
            loadLevel(currentLevelIndex);

            // Event Listeners (Only need to add these once)
            enterBtn.onclick = checkAnswer;
            inputField.addEventListener("keypress", function(event) {
                if (event.key === "Enter") {
                    checkAnswer();
                    inputField.blur(); 
                }
            });
        }

        function loadLevel(index) {
            if (index >= LEVELS.length) {
                gameComplete();
                return;
            }

            // Reset State
            const levelData = LEVELS[index];
            timeLeft = GAME_DURATION;
            isGameRunning = true;
            messageDisplay.textContent = "";
            messageDisplay.className = ""; // Remove success/fail classes
            inputField.value = "";
            inputField.disabled = false;
            inputField.focus();
            
            // Update UI
            headerTitle.textContent = `LEVEL ${index + 1} OF ${LEVELS.length}`;
            mysteryImage.src = levelData.image;
            timerDisplay.textContent = "01:00";
            timerDisplay.style.color = "var(--brand-red)";
            timerDisplay.classList.remove('timer-warning');

            // Reset Grid
            gridContainer.innerHTML = ''; 
            for (let i = 0; i < 100; i++) {
                const piece = document.createElement('div');
                piece.classList.add('grid-piece');
                gridContainer.appendChild(piece);
            }

            // Start Timers
            clearInterval(timerInterval);
            clearInterval(revealInterval);
            timerInterval = setInterval(updateTimer, 1000);
            revealInterval = setInterval(revealRandomPiece, REVEAL_SPEED);
        }

        function updateTimer() {
            if (!isGameRunning) return;
            timeLeft--;
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            if (timeLeft <= 10) timerDisplay.classList.add('timer-warning');
            if (timeLeft <= 0) handleRoundEnd(false);
        }

        function revealRandomPiece() {
            if (!isGameRunning) return;
            const hiddenPieces = document.querySelectorAll('.grid-piece:not(.revealed)');
            if (hiddenPieces.length === 0) return;
            const randomIndex = Math.floor(Math.random() * hiddenPieces.length);
            hiddenPieces[randomIndex].classList.add('revealed');
        }

        function checkAnswer() {
            if (!isGameRunning) return;
            const userGuess = inputField.value.trim().toLowerCase();
            const currentAnswers = LEVELS[currentLevelIndex].answers;

            if (isMatch(userGuess, currentAnswers)) {
                handleRoundEnd(true);
            } else {
                inputField.style.borderColor = "var(--brand-red)";
                setTimeout(() => inputField.style.borderColor = "#ddd", 500);
            }
        }

        function isMatch(guess, answers) {
            if (answers.includes(guess)) return true;
            for (let answer of answers) {
                if (answer.length < 4) { if (guess === answer) return true; continue; }
                const dist = levenshteinDistance(guess, answer);
                const allowedErrors = answer.length > 8 ? 2 : 1;
                if (dist <= allowedErrors) return true;
            }
            return false;
        }

        function levenshteinDistance(a, b) {
            const matrix = [];
            for (let i = 0; i <= b.length; i++) { matrix[i] = [i]; }
            for (let j = 0; j <= a.length; j++) { matrix[0][j] = j; }
            for (let i = 1; i <= b.length; i++) {
                for (let j = 1; j <= a.length; j++) {
                    if (b.charAt(i - 1) == a.charAt(j - 1)) {
                        matrix[i][j] = matrix[i - 1][j - 1];
                    } else {
                        matrix[i][j] = Math.min(matrix[i - 1][j - 1] + 1, Math.min(matrix[i][j - 1] + 1, matrix[i - 1][j] + 1));
                    }
                }
            }
            return matrix[b.length][a.length];
        }

        function handleRoundEnd(isWin) {
            isGameRunning = false;
            clearInterval(timerInterval);
            clearInterval(revealInterval);
            
            // Reveal full image
            document.querySelectorAll('.grid-piece').forEach(p => p.classList.add('revealed'));
            inputField.disabled = true;

            messageDisplay.classList.add('visible');
            const planeName = LEVELS[currentLevelIndex].name;

            if (isWin) {
                messageDisplay.textContent = `Correct! It is the ${planeName}.`;
                messageDisplay.className = "visible success"; // Green Text
                timerDisplay.style.color = "#27ae60";
                score++;
                
                // WAIT 3 SECONDS, THEN NEXT LEVEL
                setTimeout(() => {
                    currentLevelIndex++;
                    loadLevel(currentLevelIndex);
                }, 3000);

            } else {
                messageDisplay.textContent = `Time's up! It was the ${planeName}.`;
                messageDisplay.className = "visible fail"; // Red Text
                // Optional: You could allow them to continue anyway or Game Over here
                setTimeout(() => {
                    currentLevelIndex++;
                    loadLevel(currentLevelIndex);
                }, 4000);
            }
        }

        function gameComplete() {
            // Screen when all levels are done
            gridContainer.innerHTML = '<div style="display:flex; justify-content:center; align-items:center; height:100%; color:white; font-size:2rem; text-align:center;">ALL LEVELS COMPLETE!<br>Score: ' + score + '/' + LEVELS.length + '</div>';
            headerTitle.textContent = "GAME OVER";
            timerDisplay.textContent = "";
            inputField.style.display = "none";
            enterBtn.style.display = "none";
            mysteryImage.style.display = "none";
        }

        // Start Game
        initGame(); 
    </script>
