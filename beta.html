<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="BD Tour">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BD Tour Alicante 2026</title>

    <link rel="apple-touch-icon" href="app-icon-v2.png">
    <link rel="icon" type="image/png" sizes="32x32" href="icon.png">
    <link rel="icon" type="image/png" sizes="16x16" href="icon.png">
    <link rel="manifest" href="manifest.json">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        golf: {
                            dark: '#0A2615',   /* Augusta Green */
                            deep: '#1B4D3E',   /* Secondary Green */
                            gold: '#C5A059',   /* Trophy Gold */
                            cream: '#F5F5F0',  /* Card Stock */
                            white: '#FFFFFF'
                        }
                    },
                    fontFamily: {
                        serif: ['"Playfair Display"', 'serif'],
                        sans: ['"Lato"', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <style>
        /* --- VIEWPORT LOCK --- */
        html, body {
            position: fixed;
            height: 100%;
            width: 100%;
            overflow: hidden;
            background-color: #F5F5F0;
            overscroll-behavior: none; 
        }

        #app-container {
            height: 100%;
            width: 100%;
            overflow-y: auto; 
            overscroll-behavior-y: none; 
            -webkit-overflow-scrolling: touch;
            display: flex;
            flex-direction: column;
            padding-bottom: 20px;
        }
        
        /* Add padding when admin toolbar is visible so content isn't hidden behind it */
        body.admin-mode #app-container {
            padding-bottom: 100px; 
        }

        /* Checkbox Styling */
        input[type="checkbox"]:checked + label {
            text-decoration: line-through;
            color: #9CA3AF;
        }

        /* Links */
        #app-container a { color: #C5A059; text-decoration: underline; font-weight: bold; }

        /* Accordion Animation */
        .accordion-content {
            transition: max-height 0.3s ease-in-out, opacity 0.3s ease-in-out;
            max-height: 0;
            opacity: 0;
            overflow: hidden;
        }
        .accordion-content.open {
            max-height: 2000px;
            opacity: 1;
        }
        .arrow-icon {
            transition: transform 0.3s ease;
        }
        .arrow-icon.rotate {
            transform: rotate(180deg);
        }
        
        /* Dragging Styles */
        .draggable-source { opacity: 0.4; border: 2px dashed #C5A059; }
        .drag-handle { cursor: move; touch-action: none; }
        
        /* Animation Classes */
        .anim-obj { transform-origin: center; transform-box: fill-box; will-change: transform; }

        #landscape-warning { display: none; }
        @media screen and (orientation: landscape) {
            #app-container { display: none; }
            #landscape-warning { display: flex; }
        }

        /* --- ADMIN MODE STYLES --- */
        body.admin-mode [contenteditable="true"] {
            outline: 2px dashed rgba(197, 160, 89, 0.5); /* Gold Dashed Outline */
            padding: 2px;
            border-radius: 4px;
            background-color: rgba(255, 255, 255, 0.8);
        }
        body.admin-mode [contenteditable="true"]:focus {
            outline: 2px solid #C5A059;
            background-color: white;
        }
        .admin-only { display: none !important; }
        body.admin-mode .admin-only { display: flex !important; }
        
        /* Admin Overrides */
        body.admin-mode .section-header { pointer-events: none; } 
        body.admin-mode .section-header .editable-title { pointer-events: auto; }
        body.admin-mode .accordion-content { max-height: none !important; opacity: 1 !important; display: block; } /* Force all open */
        body.admin-mode .arrow-icon { display: none; } /* Hide arrows */

    </style>
</head>
<body class="bg-golf-cream text-gray-800 font-sans antialiased">

    <div id="landscape-warning" class="fixed inset-0 bg-golf-dark z-[100] flex flex-col items-center justify-center text-golf-gold p-10 text-center">
        <div class="text-6xl mb-4">âŸ³</div>
        <h2 class="font-serif text-3xl mb-2">Portrait Mode Only</h2>
    </div>

    <div id="app-container" class="max-w-md mx-auto bg-golf-cream shadow-2xl relative">

        <header class="bg-golf-dark pt-10 pb-8 px-6 text-center rounded-b-[30px] shadow-lg z-10 relative overflow-hidden shrink-0">
            <button id="install-btn" onclick="showInstallInstructions()" class="hidden absolute top-6 left-6 text-golf-gold hover:text-white transition z-50 p-2"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg></button>
            
            <svg id="header-glass" class="absolute bottom-0 right-0 w-48 h-auto opacity-10 text-golf-gold transform translate-x-4 translate-y-2" viewBox="0 0 200 200" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                <path d="M40 40 L160 40 L100 120 L100 180 M70 180 L130 180" stroke="currentColor" stroke-width="8" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
                <line x1="50" y1="50" x2="150" y2="50" stroke="currentColor" stroke-width="1" stroke-dasharray="4 4" opacity="0.5" />
                <g><g id="anim-stick" class="anim-obj"><line x1="0" y1="20" x2="20" y2="-20" stroke="currentColor" stroke-width="4" stroke-linecap="round"/></g><g id="anim-ball" class="anim-obj"><circle cx="0" cy="0" r="18" fill="currentColor"/><circle cx="-5" cy="-5" r="2" fill="white" opacity="0.5"/><circle cx="5" cy="-5" r="2" fill="white" opacity="0.5"/></g></g>
            </svg>

            <div class="relative z-10 pointer-events-none">
                <h1 class="font-serif text-2xl text-white tracking-wide leading-tight drop-shadow-md">BD TOUR<br><span class="text-golf-gold italic text-xl">Alicante 2026</span></h1>
                <button onclick="document.getElementById('packing-modal').classList.remove('hidden'); event.stopPropagation();" class="pointer-events-auto mt-4 bg-golf-deep border border-golf-gold text-golf-gold text-[10px] uppercase tracking-widest py-1.5 px-6 rounded-full hover:bg-black transition flex items-center justify-center mx-auto gap-2 shadow-lg"><span>âœ“</span> Packing List</button>
            </div>
        </header>

        <main class="p-4 space-y-3 flex-1" id="sections-container">
            </main>

        <div class="admin-only px-4 pb-4">
            <button onclick="addNewSection()" class="w-full border-2 border-dashed border-golf-gold text-golf-gold font-bold py-3 rounded-sm hover:bg-golf-gold hover:text-white transition uppercase tracking-widest text-xs">+ Add New Section</button>
        </div>

        <div id="quote-container" class="mt-4 px-10 text-center h-24 flex flex-col items-center justify-center select-none pointer-events-none"><div id="quote-content" class="transition-opacity duration-1000 opacity-0"></div></div>
        <div class="text-center pt-2 pb-6">
            <button onclick="document.getElementById('login-modal').classList.remove('hidden')" class="text-[9px] text-gray-300 hover:text-golf-gold uppercase tracking-widest opacity-50 mb-2">Chairman Access</button>
            <p class="text-[9px] text-gray-300">Last sync: <span id="last-sync">...</span></p>
        </div>
    </div>

    <div id="admin-toolbar" class="admin-only fixed bottom-0 left-0 right-0 bg-golf-dark border-t border-golf-gold p-3 z-[60] flex justify-between items-center shadow-2xl">
        <div class="flex gap-2">
            <button onmousedown="event.preventDefault(); disableAdminMode()" class="bg-red-900/50 border border-red-800 text-white px-3 py-2 rounded font-bold hover:bg-red-800">Ã—</button>
            <button id="btn-bold" onmousedown="event.preventDefault(); format('bold')" class="bg-white/10 text-golf-gold px-3 py-2 rounded font-bold hover:bg-white/20">B</button>
            <button id="btn-strike" onmousedown="event.preventDefault(); format('strikeThrough')" class="bg-white/10 text-golf-gold px-3 py-2 rounded font-bold hover:bg-white/20"><s>S</s></button>
            <button id="btn-link" onmousedown="event.preventDefault(); addLink()" class="bg-white/10 text-golf-gold px-3 py-2 rounded font-bold hover:bg-white/20">ðŸ”—</button>
        </div>
        <button id="btn-save-main" onclick="saveAllChanges()" class="bg-golf-gold text-golf-dark font-bold px-4 py-2 rounded shadow-lg uppercase tracking-widest text-xs hover:bg-white min-w-[100px]">SAVE</button>
    </div>

    <div id="packing-modal" class="hidden fixed inset-0 bg-golf-dark/95 z-50 flex flex-col items-center justify-center p-6 backdrop-blur-sm">
        <div class="bg-white w-full max-w-sm rounded-sm shadow-2xl overflow-hidden flex flex-col max-h-[85vh]">
            <div class="bg-golf-gold p-3 text-center flex justify-between items-center shrink-0">
                <div class="w-6"></div><h2 class="font-serif text-lg font-bold text-golf-dark">Packing List</h2><button onclick="document.getElementById('packing-modal').classList.add('hidden')" class="text-golf-dark font-bold text-xl hover:text-white">Ã—</button>
            </div>
            <div class="overflow-y-auto flex-1 p-6 space-y-6">
                <div><h3 class="text-xs font-bold text-golf-deep uppercase tracking-widest mb-3 border-b border-gray-100 pb-1">Essentials</h3><div id="list-essentials" class="space-y-3"><p class="text-xs text-gray-400 italic">Loading...</p></div></div>
                <div><h3 class="text-xs font-bold text-golf-deep uppercase tracking-widest mb-3 border-b border-gray-100 pb-1">Personal Items</h3>
                    <div class="flex gap-2 mb-4"><input id="new-item-input" type="text" placeholder="Add item..." class="flex-1 bg-gray-50 border border-gray-200 rounded-sm px-2 py-1 text-sm outline-none focus:border-golf-gold"><button onclick="addPersonalItem()" class="bg-golf-deep text-white px-3 py-1 rounded-sm text-xs font-bold hover:bg-black">+</button></div>
                    <div id="list-personal" class="space-y-3"></div>
                </div>
                <div class="admin-only pt-4 border-t border-gray-200 mt-4">
                    <label class="block text-xs font-bold text-golf-dark uppercase mb-1">Edit Essentials (Admin)</label>
                    <textarea id="edit-packing-essentials" rows="4" class="w-full p-2 text-sm border rounded bg-yellow-50"></textarea>
                </div>
            </div>
            <button onclick="document.getElementById('packing-modal').classList.add('hidden')" class="bg-gray-100 p-3 text-center text-xs font-bold text-gray-500 hover:bg-gray-200 uppercase tracking-wide shrink-0">Close</button>
        </div>
    </div>

    <div id="install-modal" class="hidden fixed inset-0 bg-black/80 z-[100] flex flex-col items-center justify-end pb-10 text-white animate-fade-in" onclick="document.getElementById('install-modal').classList.add('hidden')">
        <div class="bg-golf-dark border border-golf-gold p-6 rounded-t-2xl w-full max-w-md text-center shadow-2xl relative">
            <div class="absolute -top-3 left-1/2 transform -translate-x-1/2 w-12 h-1 bg-gray-500 rounded-full"></div>
            <h3 class="font-serif text-xl text-golf-gold mb-2">Install App</h3>
            <p class="text-sm text-gray-300 mb-6">For the best experience, add this to your home screen.</p>
            <div class="flex items-center justify-center gap-4 text-sm font-bold text-white mb-2"><span>1. Tap Share</span><svg class="w-6 h-6 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z"></path></svg></div>
            <div class="flex items-center justify-center gap-4 text-sm font-bold text-white"><span>2. Add to Home Screen</span><div class="border border-white rounded px-2 text-[10px] uppercase">Plus</div></div>
            <div class="mt-8 text-xs text-gray-500">Tap anywhere to close</div>
        </div>
        <div class="absolute bottom-2 left-1/2 transform -translate-x-1/2 text-golf-gold animate-bounce">â†“</div>
    </div>

    <div id="login-modal" class="hidden fixed inset-0 bg-black/90 z-50 flex items-center justify-center p-6">
        <div class="bg-white w-full max-w-xs p-8 rounded-sm shadow-2xl text-center">
            <h2 class="font-serif text-2xl text-golf-dark mb-6">Chairman Login</h2>
            <input type="email" id="email" placeholder="Email" class="w-full bg-gray-50 border-b-2 border-gray-200 p-3 mb-4 outline-none">
            <input type="password" id="password" placeholder="Password" class="w-full bg-gray-50 border-b-2 border-gray-200 p-3 mb-6 outline-none">
            <button id="btn-login" class="w-full bg-golf-dark text-golf-gold font-bold py-3 uppercase tracking-wider text-sm">Authenticate</button>
            <button onclick="document.getElementById('login-modal').classList.add('hidden')" class="mt-4 text-xs text-gray-400 underline">Cancel</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, onSnapshot, updateDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // ðŸ”¥ðŸ”¥ðŸ”¥ PASTE FIREBASE CONFIG HERE ðŸ”¥ðŸ”¥ðŸ”¥
        const firebaseConfig = {
apiKey: "AIzaSyBQZPcQ6FcnglNHg10d__6PQDdd_OjT74U",
authDomain: "golfapp-10c53.firebaseapp.com",
projectId: "golfapp-10c53",
storageBucket: "golfapp-10c53.firebasestorage.app",
messagingSenderId: "251112200135",
appId: "1:251112200135:web:6b1d0386a2cc042ae8abe2"
        };
        // ðŸ”¥ðŸ”¥ðŸ”¥ END PASTE ðŸ”¥ðŸ”¥ðŸ”¥

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        // âš ï¸ DEMO MODE: USING "DEMO" DOCUMENT TO NOT BREAK OLD APP
        const tripRef = doc(db, "trip", "demo"); 

        // GLOBAL STATE
        let isAdmin = false;
        let sectionsData = [];
        let globalEssentialsList = [];

        // --- RENDER SECTIONS ---
        const container = document.getElementById('sections-container');
        
        function renderSections(sections) {
            // If dragging, don't re-render entire DOM to avoid glitches
            if (document.querySelector('.draggable-source')) return;

            container.innerHTML = '';
            
            // Check User Order Preference (if not admin mode, we respect user order. In admin mode, we show True DB order)
            let displayOrder = sections;
            if (!isAdmin) {
                const savedOrder = JSON.parse(localStorage.getItem('userSectionOrder') || '[]');
                if (savedOrder.length > 0) {
                    // Sort sections based on saved ID order
                    displayOrder = sections.sort((a, b) => {
                        const indexA = savedOrder.indexOf(a.id);
                        const indexB = savedOrder.indexOf(b.id);
                        if (indexA === -1) return 1; // New sections go to bottom
                        if (indexB === -1) return -1;
                        return indexA - indexB;
                    });
                }
            }

            displayOrder.forEach((sec, index) => {
                // Determine styling (Gold vs Deep vs Dark cycle)
                let borderColor = 'border-golf-gold';
                let iconColor = 'text-golf-gold';
                let textColor = 'text-golf-deep';
                
                if (index % 3 === 1) { // Deep
                    borderColor = 'border-golf-deep';
                    iconColor = 'text-golf-deep';
                    textColor = 'text-golf-deep';
                } else if (index % 3 === 2) { // Dark (rounds)
                    borderColor = 'border-golf-dark';
                    iconColor = 'text-golf-deep';
                    textColor = 'text-golf-deep';
                }

                const el = document.createElement('div');
                el.className = `draggable-item bg-white rounded-sm border-t-2 ${borderColor} shadow-sm overflow-hidden mb-3 relative`;
                el.id = sec.id;
                if (!isAdmin) el.draggable = true;

                // Trash Button (Admin Only)
                const deleteBtn = `<button onclick="deleteSection('${sec.id}')" class="admin-only absolute top-0 right-0 bg-red-500 text-white p-2 text-xs font-bold z-20 hover:bg-red-700">DELETE</button>`;

                el.innerHTML = `
                    ${deleteBtn}
                    <div class="section-header w-full flex justify-between items-center p-4 bg-white hover:bg-gray-50 transition cursor-pointer" onclick="toggleAccordion('content-${sec.id}', 'arrow-${sec.id}')">
                        <div class="flex items-center gap-3 flex-1">
                            <div class="drag-handle text-gray-300 cursor-move p-2 -ml-2 hover:text-golf-gold ${isAdmin ? 'hidden' : ''}" onmousedown="event.stopPropagation()">â‹®â‹®</div>
                            <svg class="w-5 h-5 ${iconColor}" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19 9l-7 7-7-7"></path></svg>
                            <h3 class="editable-title font-serif text-base ${textColor} font-bold outline-none" ${isAdmin ? 'contenteditable="true"' : ''}>${sec.title}</h3>
                        </div>
                        <svg id="arrow-${sec.id}" class="arrow-icon w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </div>
                    <div id="content-${sec.id}" class="accordion-content border-t border-gray-100">
                        <div class="p-4 pt-2">
                            <div class="editable-content text-xs leading-relaxed text-gray-600 whitespace-pre-line outline-none" ${isAdmin ? 'contenteditable="true"' : ''}>${sec.content}</div>
                        </div>
                    </div>
                `;
                
                // Add dragging events (Same logic as before)
                addDragEvents(el);
                
                container.appendChild(el);
            });
        }

        // --- ADMIN ACTIONS ---
        
        window.addNewSection = function() {
            const newId = 'sec_' + Date.now();
            sectionsData.push({
                id: newId,
                title: "New Section Title",
                content: "Add content here...",
                color: "gold" // default
            });
            renderSections(sectionsData);
            setTimeout(() => window.scrollTo(0, document.body.scrollHeight), 100);
        }

        window.deleteSection = function(id) {
            if(confirm("Are you sure you want to delete this section?")) {
                sectionsData = sectionsData.filter(s => s.id !== id);
                renderSections(sectionsData);
            }
        }

window.saveAllChanges = async function() {
            const btn = document.getElementById('btn-save-main');
            btn.innerText = "SAVING...";
            
            // 1. Scrape the DOM to get latest edits (titles, contents)
            const newSections = [];
            container.querySelectorAll('.draggable-item').forEach(el => {
                const id = el.id;
                // Safe check to ensure we aren't grabbing null elements
                const titleEl = el.querySelector('.editable-title');
                const contentEl = el.querySelector('.editable-content');
                
                if (titleEl && contentEl) {
                    newSections.push({ 
                        id: id, 
                        title: titleEl.innerText, 
                        content: contentEl.innerHTML // innerHTML preserves links/bold
                    });
                }
            });

            // 2. Scrape Packing List
            const packingListRaw = document.getElementById('edit-packing-essentials').value;

            try {
                // 3. Save to Firestore (Using setDoc to create if missing)
                await setDoc(tripRef, {
                    sections: newSections,
                    packing_list: packingListRaw
                }, { merge: true });
                
                alert("Saved Successfully!");
                btn.innerText = "SAVE";
            } catch (error) {
                console.error(error); // Log full error to console
                alert("Error saving: " + error.message);
                btn.innerText = "RETRY";
            }
        };
            });

            // 2. Scrape Packing List (Admin Edit)
            const packingListRaw = document.getElementById('edit-packing-essentials').value;

            try {
                // 3. Save to Firestore
                await updateDoc(tripRef, {
                    sections: newSections,
                    packing_list: packingListRaw
                });
                alert("Saved Successfully!");
                btn.innerText = "SAVE";
            } catch (error) {
                alert("Error saving: " + error.message);
                btn.innerText = "RETRY";
            }
        };

        // --- AUTH ---
        document.getElementById('btn-login').addEventListener('click', async () => {
            const email = document.getElementById('email').value;
            const pass = document.getElementById('password').value;
            try {
                await signInWithEmailAndPassword(auth, email, pass);
                document.getElementById('login-modal').classList.add('hidden');
                enableAdminMode();
            } catch (error) {
                alert("Access Denied.");
            }
        });

        function enableAdminMode() {
            isAdmin = true;
            document.body.classList.add('admin-mode');
            renderSections(sectionsData); // Re-render to add contenteditable
        }

        // NEW: Exit Admin
        window.disableAdminMode = function() {
            isAdmin = false;
            document.body.classList.remove('admin-mode');
            renderSections(sectionsData); // Re-render to remove edits/lines
        }

        // --- DATA LISTENER & MIGRATION ---
        onSnapshot(tripRef, (doc) => {
            if (doc.exists()) {
                const data = doc.data();
                const now = new Date();
                document.getElementById('last-sync').innerText = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

                // PACKING LIST
                if (data.packing_list) {
                    globalEssentialsList = data.packing_list.split('\n');
                    document.getElementById('edit-packing-essentials').value = data.packing_list;
                } else {
                    globalEssentialsList = ["Passport", "Clubs", "Golf Shoes"];
                }
                renderPackingLists();

                // SECTIONS MIGRATION LOGIC
                if (data.sections && Array.isArray(data.sections)) {
                    // New Format Exists -> Use it
                    sectionsData = data.sections;
                    renderSections(sectionsData);
                } else {
                    // OLD FORMAT DETECTED -> MIGRATE ON THE FLY
                    console.log("Migrating old data structure...");
                    sectionsData = [
                        { id: 'flight', title: 'Flight Plan', content: data.flights || 'No details' },
                        { id: 'transport', title: 'Transportation', content: data.transport || 'No details' },
                        { id: 'rounds', title: 'Golf Rounds', content: data.rounds || 'No details' },
                        { id: 'team1', title: 'Team 1', content: data.team1 || 'No roster' },
                        { id: 'team2', title: 'Team 2', content: data.team2 || 'No roster' },
                        { id: 'hotel', title: 'Accommodation', content: data.hotel || 'No details' },
                        { id: 'dinner', title: 'Dining', content: data.dinner || 'No details' }
                    ];
                    renderSections(sectionsData);
                }
            }
        });

        // --- DRAG EVENTS HELPER ---
        function addDragEvents(item) {
            item.addEventListener('dragstart', (e) => {
                setTimeout(() => item.classList.add('draggable-source'), 0);
            });
            item.addEventListener('dragend', () => {
                item.classList.remove('draggable-source');
                if(!isAdmin) saveUserOrder(); // Only save user order if not admin
            });
            // Touch handlers for mobile sorting
            const handle = item.querySelector('.drag-handle');
            if (handle) {
                let draggedItem = null;
                handle.addEventListener('touchstart', (e) => { e.preventDefault(); draggedItem = item; item.classList.add('draggable-source'); }, {passive: false});
                handle.addEventListener('touchmove', (e) => {
                    e.preventDefault();
                    if (!draggedItem) return;
                    const touch = e.touches[0];
                    const elementBelow = document.elementFromPoint(touch.clientX, touch.clientY);
                    const dropTarget = elementBelow ? elementBelow.closest('.draggable-item') : null;
                    if (dropTarget && dropTarget !== draggedItem) {
                        const rect = dropTarget.getBoundingClientRect();
                        const next = (touch.clientY - rect.top) / (rect.bottom - rect.top) > 0.5;
                        container.insertBefore(draggedItem, next ? dropTarget.nextSibling : dropTarget);
                    }
                }, {passive: false});
                handle.addEventListener('touchend', () => {
                    if (draggedItem) { draggedItem.classList.remove('draggable-source'); saveUserOrder(); draggedItem = null; }
                });
            }
        }

        function saveUserOrder() {
            const order = [...container.querySelectorAll('.draggable-item')].map(el => el.id);
            localStorage.setItem('userSectionOrder', JSON.stringify(order));
        }

        // --- ANIMATION ---
        const stickEl = document.getElementById('anim-stick');
        const ballEl = document.getElementById('anim-ball');
        function animateBubbles() {
            const time = Date.now();
            if(ballEl) ballEl.setAttribute('transform', `translate(${100 + Math.sin(time * 0.0005) * 8}, ${85 + Math.cos(time * 0.0008) * 4})`);
            if(stickEl) stickEl.setAttribute('transform', `translate(${100 + Math.sin(time * 0.0003 + 2) * 10}, ${65 + Math.cos(time * 0.0004) * 5}) rotate(${Math.sin(time * 0.0002) * 8})`);
            requestAnimationFrame(animateBubbles);
        }
        animateBubbles();

        // --- HELPERS ---
        window.format = function(command) { document.execCommand(command, false, null); };
        window.addLink = function() { const url = prompt("Enter URL:", "https://"); if(url) document.execCommand('createLink', false, url); };
        window.toggleAccordion = function(contentId, arrowId) {
            if(document.body.classList.contains('admin-mode')) return; // No toggle in admin mode
            const content = document.getElementById(contentId);
            const arrow = document.getElementById(arrowId);
            const isOpen = content.classList.contains('open');
            // Close others
            document.querySelectorAll('.accordion-content').forEach(el => el.classList.remove('open'));
            document.querySelectorAll('.arrow-icon').forEach(el => el.classList.remove('rotate'));
            if(!isOpen) { content.classList.add('open'); arrow.classList.add('rotate'); }
        };
        // Install Logic
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); deferredPrompt = e; });
        window.showInstallInstructions = function() {
            if (deferredPrompt) { deferredPrompt.prompt(); deferredPrompt.userChoice.then(() => deferredPrompt = null); }
            else { document.getElementById('install-modal').classList.remove('hidden'); }
        };
        // Check install status
        if (!window.matchMedia('(display-mode: standalone)').matches) document.getElementById('install-btn').classList.remove('hidden');

        // Quote & Packing List Logic (Standard)
        const quotes = ["The most important shot in golf is the next one. â€“ Ben Hogan", "Golf is a good walk spoiled. â€“ Mark Twain", "Drive for show, putt for dough.", "Keep your head down."];
        const quoteContainer = document.getElementById('quote-content');
        function cycleQuote() {
            quoteContainer.classList.remove('opacity-100');
            quoteContainer.classList.add('opacity-0');
            setTimeout(() => {
                const r = quotes[Math.floor(Math.random() * quotes.length)].split(' â€“ ');
                quoteContainer.innerHTML = r.length > 1 ? `<span class="block mb-2 text-sm text-golf-gold">"${r[0]}"</span><span class="block text-[10px] font-sans font-bold tracking-widest uppercase opacity-60 text-golf-gold">&mdash; ${r[1]}</span>` : `<span class="block text-sm text-golf-gold">"${r[0]}"</span>`;
                quoteContainer.classList.remove('opacity-0');
                quoteContainer.classList.add('opacity-100');
            }, 1000);
        }
        cycleQuote(); setInterval(cycleQuote, 8000);
    </script>
</body>
</html>Æ’
